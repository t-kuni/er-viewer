# テストコード改善タスク

## 目的
- テストコード内でstateを直接検証することを禁止し、全てinfrastructure層のモックを通して検証する
- スキップされているテストを有効化して修正する

## タスク一覧

### 1. state直接アクセスの修正

#### error-handling.test.ts (11箇所)
- [ ] `app.state.error`の検証をモック呼び出し検証に置き換える
- [ ] `app.state.loading`の検証をモック呼び出し検証に置き換える
- [ ] `app.state.layoutData`の検証をモック呼び出し検証に置き換える
- [ ] `app.state.erData`の検証をモック呼び出し検証に置き換える

#### rendering.test.ts (28箇所)
- [ ] `app.state.entityBounds`の検証をモック呼び出し検証に置き換える
- [ ] `app.state.erData`の検証をモック呼び出し検証に置き換える
- [ ] `app.state.clusteredPositions`の検証をモック呼び出し検証に置き換える
- [ ] `app.state.layoutData`の検証をモック呼び出し検証に置き換える

#### user-interaction.test.ts (8箇所)
- [ ] 全てのstate直接アクセスをモック呼び出し検証に置き換える

#### initialization-setup.test.ts (4箇所)
- [ ] `app.state`の検証をモック呼び出し検証に置き換える
- [ ] `app.state.canvas`の検証をモック呼び出し検証に置き換える
- [ ] `app.state.sidebar`の検証をモック呼び出し検証に置き換える
- [ ] `app.state.erData`の検証をモック呼び出し検証に置き換える

#### state-management.test.ts (4箇所)
- [ ] 全てのstate直接アクセスをモック呼び出し検証に置き換える

### 2. スキップされているテストの修正 (data-management.test.ts)

- [ ] `増分リバースエンジニアリング - 既存レイアウトを保持しながら新しいエンティティを追加`のテストを有効化・修正
- [ ] `増分リバースエンジニアリング - 削除されたエンティティのレイアウトを削除`のテストを有効化・修正
- [ ] `増分リバースエンジニアリング - 既存エンティティの位置とサイズを保持`のテストを有効化・修正
- [ ] `増分リバースエンジニアリング - 複数の新規エンティティが適切にクラスタリングされる`のテストを有効化・修正

### 3. ドキュメントの確認・更新

- [ ] CLAUDE.mdの内容確認（既に適切な記述があるか確認）
- [ ] TEST-SPECIFICATION.mdの内容確認・必要に応じて更新
- [ ] TEST-GUIDELINES.mdの内容確認・必要に応じて更新

### 4. 最終確認

- [ ] `npm test`が全てパスすることを確認
- [ ] 修正後のテストがinfrastructure層のモックのみを使用していることを確認
- [ ] スキップされているテストが存在しないことを確認

## 作業方針

1. **品質重視**: 各テストケースの意図を理解し、適切なモック検証に置き換える
2. **段階的な修正**: ファイル単位で修正し、都度テストを実行して確認
3. **一貫性の確保**: 既に正しく実装されているテストファイル（data-management.test.ts、ui-components.test.ts）のパターンを参考にする