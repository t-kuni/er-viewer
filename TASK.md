# 修正が必要なタスク

## 最優先（基本機能）

### データベース接続・リバースエンジニアリング
- [x] RDBからER図をリバースエンジニアリング機能の実装（実装済み・動作確認済み）
- [x] MySQLからテーブル情報を取得する処理の実装（DatabaseManagerで実装済み）
- [x] 取得したテーブル情報をER図として表示する処理の実装（実装済み・動作確認済み）
- [x] 増分リバース機能（差分反映）の実装（実装済み・既存エンティティ位置保持機能あり）

### ER図表示機能
- [x] エンティティ表示（テーブル名、カラム名一覧）の実装
- [x] カラムの種別に応じた絵文字表示の実装
- [x] テーブル名・カラム名の長さに応じたエンティティ幅調整の実装
- [x] リレーション表示（Polyline接続）の実装
- [x] エンティティ配置の初期クラスタリング機能の実装

## 高優先（インタラクション機能）

### ユーザーインタラクション
- [x] エンティティホバー時のハイライト機能の実装
- [x] リレーションホバー時のハイライト機能の実装
- [x] エンティティクリック時の右サイドバーDDL表示機能の実装（実装済み・動作確認済み）
- [x] DDLのsyntax highlight機能の実装（Prism.js使用・実装済み）
- [x] エンティティドラッグ移動機能の実装（実装済み・視覚的フィードバック追加済み）

### 基本操作
- [x] マウスホイールでの拡大縮小機能の実装（実装済み・動作確認済み）
- [x] スペース+ドラッグでのキャンバス移動機能の実装（実装済み・テスト確認済み）
- [x] マウスホイール押し込み+ドラッグでのキャンバス移動機能の実装（実装済み・テスト確認済み）

## 中優先（レイヤー・保存機能）

### レイヤー管理
- [x] 左サイドバーのレイヤー一覧表示機能の実装（LayerManagerで実装済み・動作確認済み）
- [x] レイヤーのドラッグ&ドロップ順序変更機能の実装（LayerManagerで実装済み・テスト確認済み）
- [x] レイヤーの表示順序制御機能の実装（LayerManagerで実装済み・レイヤー順序変更時にlayerOrderChangedイベント発火）

### データ管理
- [ ] 「ER図のデータ」と「エンティティの配置に関するデータ」の保存機能の実装
- [ ] 保存データの読み込み機能の実装
- [ ] エンティティ配置データの維持機能（増分リバース時）の実装

### 描画機能
- [ ] 矩形描画機能の実装
- [ ] 矩形の色・サイズ・位置のインタラクティブ編集機能の実装
- [ ] テキスト描画機能の実装
- [ ] テキストの位置・色・サイズのインタラクティブ編集機能の実装

## lower優先（UI/UX改善）

### サイドバー機能
- [ ] 左サイドバーの開閉機能の実装
- [ ] 左サイドバーのリサイズ機能の実装
- [ ] 右サイドバーの×ボタン機能の実装

### その他機能
- [ ] ビルド情報表示機能の実装
- [ ] 操作ガイドのより詳細な情報追加
- [ ] エラーハンドリングの改善（404エラーの解消）

## 確認・テスト項目

### 動作確認
- [ ] docker-compose環境での動作確認
- [ ] ブラウザでの基本操作確認
- [ ] データベース接続確認
- [ ] 環境変数設定の確認
- [ ] volumeマウント機能の確認

### データ永続化
- [ ] 保存データがvolume経由で永続化されることの確認
- [ ] リポジトリのVCSで管理可能な形式での保存確認

## 技術的な課題

### 修正が必要な問題
- [x] 404エラーの原因調査と修正（TypeScriptのビルドで解決）
- [x] リバースエンジニアボタンが動作しない問題の修正（TypeScriptのコンパイルエラー修正で解決）
- [ ] ビルド情報ボタンが動作しない問題の修正
- [ ] フロントエンド-バックエンド間の通信問題の修正

## 作業進捗記録

### 2025-07-02

#### 完了したタスク
1. **リバースエンジニアリング機能の修正**
   - TypeScriptのコンパイルエラーを修正
   - 型アサーションの追加（Event → MouseEvent/WheelEvent）
   - Layerタイプのインポート追加
   - インフラストラクチャ層のジェネリック型対応
   - `npm run build:ts`でビルド完了
   - リバースエンジニアボタンが正常に動作することを確認

2. **404エラーの解決**
   - 原因：TypeScriptがコンパイルされていなかった
   - 解決：TypeScriptのビルドで`app-new.js`が生成され、404エラーが解消

#### 追加で必要なタスク
- TypeScriptの自動ビルド環境の整備（開発効率向上のため）

#### エンティティ表示機能の実装（2025-07-02）
1. **実装内容**
   - カラム表示から型情報を削除（仕様通り、型は右サイドバーのDDLで確認）
   - `calculateEntityWidth`関数を追加し、テーブル名とカラム名の長さに応じてエンティティ幅を動的に計算
   - 最小幅150px、文字幅8px、絵文字幅20pxで計算
   - テストの修正（型情報削除に対応）

2. **確認項目**
   - すべてのテストが通過（92 passed）
   - TypeScriptの型チェックも通過

#### リレーション表示機能の確認（2025-07-02）
1. **調査内容**
   - コードベース調査の結果、リレーション表示機能は既に実装済みであることを確認
   - `renderRelationships()`メソッドがリレーションを描画
   - `calculatePolylinePath()`メソッドが上下左右方向のみのPolylineで接続（仕様通り）
   - テストも通過し、正常に動作

2. **動作確認**
   - ブラウザで確認したところ、リレーションの線は正常に描画されている
   - ただし、エンティティが画面外に配置されているため、リレーション線も画面外に伸びている
   - 初期配置の問題であり、リレーション表示機能自体は正常に動作

3. **結論**
   - リレーション表示（Polyline接続）の実装は完了済み
   - 次の優先タスクは「エンティティ配置の初期クラスタリング機能の実装」

#### エンティティ配置の初期クラスタリング機能の実装（2025-07-02）
1. **調査内容**
   - `ClusteringEngine`クラスが既に実装されていることを確認
   - クラスタリング機能は実装済みだが、`shouldApplyInitialClustering`メソッドが常に`true`を返していた

2. **実装内容**
   - `shouldApplyInitialClustering`メソッドを修正
   - 初回のリバースエンジニアリング時（全てのエンティティに位置情報がない場合）のみクラスタリングを適用するように変更
   - 増分リバース時は既存エンティティの位置を保持し、新規エンティティのみ左上に配置

3. **確認項目**
   - TypeScriptのビルドが成功
   - すべてのテストが通過（92 passed）
   - TypeScriptの型チェックも通過
#### エンティティホバー時のハイライト機能の実装（2025-07-02）
1. **調査内容**
   - コードベース調査の結果、エンティティホバー時のハイライト機能は既に実装済みであることを確認
   - `updateHover`メソッドがmousemoveイベントで呼ばれる
   - `highlightEntity`メソッドがエンティティとその関連エンティティ、リレーション、カラムをハイライトする
   - `updateHighlightLayer`メソッドで最前面に表示する処理を行う
   - CSSで`.highlighted`クラスのスタイルが定義されている

2. **テストの追加**
   - `tests/entity-hover-highlight.test.ts`を作成
   - エンティティホバー時の関連要素ハイライトのテストを実装
   - エンティティからマウスが離れた時のハイライトクリアのテストを実装

3. **確認項目**
   - すべてのテストが通過（94 passed）
   - TypeScriptの型チェックも通過
   - 機能は既に実装済みで正常に動作することを確認

#### リレーションホバー時のハイライト機能の実装（2025-07-02）
1. **調査内容**
   - コードベース調査の結果、リレーションホバー時のハイライト機能も既に実装済みであることを確認
   - `updateHover`メソッドで`.relationship`クラスを持つ要素をチェック
   - `highlightRelationship`メソッドがリレーションと両端のエンティティ、カラムをハイライトする
   - CSS（196-228行目）でリレーションのホバー時のスタイルが定義済み

2. **テストの追加**
   - `tests/relationship-hover-highlight.test.ts`を作成
   - リレーションホバー時の関連要素ハイライトのテストを実装
   - リレーションからマウスが離れた時のハイライトクリアのテストを実装

3. **確認項目**
   - すべてのテストが通過（96 passed）
   - TypeScriptの型チェックも通過
   - 機能は既に実装済みで正常に動作することを確認
   - ブラウザでの動作確認でリレーションの線が正しく描画されていることを確認

#### エンティティクリック時の右サイドバーDDL表示機能の確認（2025-07-02）
1. **調査内容**
   - コードベース調査の結果、右サイドバーDDL表示機能は既に実装済みであることを確認
   - `handleCanvasClick`メソッドでエンティティクリックを処理（1275-1296行）
   - `showTableDetails`メソッドでAPIからDDLを取得（1361行〜）
   - `showSidebar`メソッドで右サイドバーにDDLを表示（1384-1406行）
   - Prism.jsを使ってSQL構文ハイライトも実装済み（1401-1403行）

2. **テストの確認**
   - `user-interaction.test.ts`に既存のテストが存在
   - エンティティクリック、DDL表示、構文ハイライトのテストが実装済み
   - テストカバレッジも十分であることを確認

#### エンティティドラッグ移動機能の改善（2025-07-02）
1. **調査内容**
   - エンティティドラッグ移動機能は既に部分的に実装済みであることを確認
   - マウスイベントハンドラー、ドラッグ状態管理、位置更新ロジックは実装済み
   - 視覚的フィードバックが不足していることを発見

2. **実装内容**
   - `.entity.dragging`クラスのCSSスタイルを追加（public/style.css）
     - ドロップシャドウを強調し、透明度を0.8に設定
     - カーソルを`grabbing`に変更
   - `startEntityDrag`メソッドでドラッグ開始時に`dragging`クラスを追加
   - `endInteraction`メソッドでドラッグ終了時に`dragging`クラスを削除

3. **テストの追加**
   - `user-interaction.test.ts`にドラッグ視覚的フィードバックのテストを追加
   - ドラッグ開始時の`addClass`呼び出しを検証
   - ドラッグ終了時の`removeClass`呼び出しを検証

4. **確認項目**
   - TypeScriptのビルドが成功
   - すべてのテストが通過（98 passed）
   - TypeScriptの型チェックも通過

#### マウスホイールでの拡大縮小機能の確認（2025-07-02）
1. **調査内容**
   - handleCanvasWheelメソッドが既に実装済みであることを確認（1243-1278行目）
   - wheel イベントハンドラーが適切に登録されている（978行目）
   - 拡大率は 0.1 〜 5.0 の範囲で制限されている
   - マウス位置を中心にズームする機能も実装済み

2. **テストの確認**
   - user-interaction.test.ts に詳細なテストが実装済み（777-1003行目）
   - 「マウスホイールを上に回すと拡大される」テスト
   - 「マウスホイールを下に回すと縮小される」テスト  
   - 「ズームの最小値と最大値が制限される」テスト
   - 全てのテストが通過（98 passed）

3. **結論**
   - マウスホイールでの拡大縮小機能は完全に実装済み
   - 操作ガイドにも「マウスホイール: 拡大縮小」と明記されている
   - ブラウザでの動作も確認済み

#### スペース+ドラッグでのキャンバス移動機能の確認（2025-07-02）
1. **調査内容**
   - コードベース調査の結果、スペース+ドラッグでのキャンバス移動機能は既に実装済みであることを確認
   - handleKeyDown/handleKeyUpメソッドが実装済み（1330-1347行目）
   - isSpacePressedの状態管理が実装済み（初期値false、144行目）
   - handleCanvasMouseDownでスペース+クリックのパン開始処理が実装済み（1042行目）
   - startPan、updatePan、endInteractionメソッドでパン処理が実装済み

2. **テストの確認**
   - tests/user-interaction.test.ts に詳細なテストが実装済み（1006-1148行目）
   - 「スペースキーとドラッグによるスクロール」テストセクション
   - 「スペースキーを押しながらドラッグするとスクロールできる」テスト
   - 全てのテストが通過（98 passed）

3. **タスクの進捗**
   - ApplicationStateの型定義を修正（drawingMode、isSpacePressed、currentDrawingRect）
   - TypeScriptの型エラーを解消
   - npm testとnpm run typecheckが正常に完了

#### マウスホイール押し込み+ドラッグでのキャンバス移動機能の確認（2025-07-02）
1. **調査内容**
   - コードベース調査の結果、マウスホイール押し込み（中ボタン）によるパン機能は既に実装済みであることを確認
   - `handleCanvasMouseDown`メソッドで`event.button === 1`（中央ボタン）の処理が実装済み（1041行目）
   - 3つのパン開始方法が実装済み：中ボタン、Shift+左ボタン、スペース+左ボタン
   
2. **テストの確認**
   - tests/user-interaction.test.ts に「マウスホイール押し込みながらドラッグでもスクロールできる」テストが実装済み（1150-1232行目）
   - テストでは中央ボタン（button: 1）でのドラッグによるパン動作を検証
   - 全98個のテストが通過し、TypeScriptの型チェックもエラーなし
   
3. **結論**
   - マウスホイール押し込み+ドラッグでのキャンバス移動機能は完全に実装済み
   - 機能は正常に動作し、適切なテストカバレッジも確保されている

#### レイヤー管理機能の確認（2025-07-02）
1. **調査内容**
   - LayerManagerクラスの実装を確認
   - レイヤー一覧表示機能（renderLayersメソッド）が実装済み
   - ドラッグ&ドロップによる順序変更機能（setupDragAndDropメソッド）が実装済み
   - レイヤー順序変更時にlayerOrderChangedイベントを発火して再描画をトリガー
   - layer-drag-drop.test.tsで詳細なテストが実装済み

2. **確認項目**
   - TypeScriptのビルドが成功
   - すべてのテストが通過（98 passed）
   - TypeScriptの型チェックも通過
   
3. **結論**
   - レイヤー管理機能（一覧表示、ドラッグ&ドロップ、表示順序制御）は全て実装済み
   - 次のタスクは「データ管理」カテゴリの保存・読み込み機能
