# ER Viewer テストケース仕様書

## 📋 概要

本ドキュメントは、ER Viewerアプリケーションのテストケースの意図と検証内容を明文化したものです。各テストケースが何を検証し、どのような期待値を持つかを詳細に記載しています。

## 🎯 テスト設計方針

- **E2E風統合テスト**: Infrastructure層のみモック化し、ビジネスロジックは実際のコードを使用
- **AAAパターン**: Arrange（準備）、Act（実行）、Assert（検証）の3ステップ構造
- **Mock検証中心**: stateの検証ではなく、Infrastructure Mockの呼び出し履歴を検証
- **可読性重視**: DRY原則よりもテストの可読性を優先

## 📝 テストケース詳細

### 1. 初期化とセットアップ

#### 1.1 アプリケーション初期化

##### テスト: アプリケーションが正常に初期化される
- **目的**: ERViewerApplicationのインスタンスが正しく作成され、必要な状態が初期化されることを検証
- **検証内容**:
  - appインスタンスが定義されている
  - DOM要素 'er-canvas' と 'sidebar' がgetElementByIdで取得できる
  - 必要なイベントリスナーが設定されている（dynamic-layer、error-container）
- **前提条件**: InfrastructureMockとモックERデータが準備されている

##### テスト: キャンバスが正しく初期化される
- **目的**: SVGキャンバス要素が適切な属性で初期化されることを検証
- **検証内容**:
  - DOM要素 'er-canvas' が存在する
  - width属性が '800' に設定されている
  - height属性が '600' に設定されている
- **前提条件**: InfrastructureMockが正しくセットアップされている

#### 1.2 初期データロード

##### テスト: 初期データがロードされる
- **目的**: アプリケーション起動時に初期ERデータが正しく読み込まれることを検証
- **検証内容**:
  - '/api/er-data' へのGETリクエストが発行される
  - リクエストのヘッダーとタイムスタンプが含まれる
  - レスポンスデータがapp.state.erDataに設定される
  - エンティティ数が期待値（2つ）と一致する
- **前提条件**: モックレスポンスが設定されている

### 2. レンダリング

#### 2.1 エンティティ描画

##### テスト: エンティティが正しく描画される
- **目的**: ERデータのエンティティがキャンバス上に正しく描画されることを検証
- **検証内容**:
  - dynamic-layer要素が存在する
  - エンティティ要素が作成される
  - エンティティに 'entity draggable' クラスが設定される
- **前提条件**: ERデータにusersとpostsエンティティが含まれる

##### テスト: エンティティバウンドが正しく設定される
- **目的**: エンティティの位置情報が正しく設定されることを検証
- **検証内容**:
  - 各エンティティの位置（x, y座標）が正しく設定される
  - transform属性が適切に設定される
- **前提条件**: レイアウトデータに位置情報が含まれる

#### 2.2 リレーションシップ描画

##### テスト: リレーションシップが正しく描画される
- **目的**: エンティティ間のリレーションシップが正しく描画されることを検証
- **検証内容**:
  - relationships-group要素が作成される
  - パス要素が作成される
  - パスのd属性が設定される
- **前提条件**: posts.user_id → users.idのリレーションシップが定義されている

##### テスト: リレーションシップレンダリングの詳細検証
- **目的**: リレーションシップの詳細な描画属性が正しく設定されることを検証
- **検証内容**:
  - stroke属性が '#333' に設定される
  - stroke-width属性が '2' に設定される
  - fill属性が 'none' に設定される
  - marker-end属性が設定される
- **前提条件**: リレーションシップが定義されている

##### テスト: リレーションシップパスの座標が正しく計算される
- **目的**: リレーションシップのパスが正しい座標で描画されることを検証
- **検証内容**:
  - パスのd属性に正しい座標が含まれる
  - 始点と終点の座標が期待値と一致する
- **前提条件**: エンティティの位置が定義されている

#### 2.3 ビューポート操作

##### テスト: パン操作でビューポートが更新される
- **目的**: マウスドラッグによるキャンバスのパン操作が正しく動作することを検証
- **検証内容**:
  - dynamic-layerのtransform属性が更新される
  - translateの値が正しく設定される
- **前提条件**: マウスイベントがシミュレートされる

##### テスト: ズーム操作でスケールが更新される
- **目的**: ホイールイベントによるズーム操作が正しく動作することを検証
- **検証内容**:
  - dynamic-layerのtransform属性にscaleが含まれる
  - ズーム倍率が正しく適用される
- **前提条件**: ホイールイベントがシミュレートされる

#### 2.4 クラスタリング機能

##### テスト: エンティティにpositionがない場合、自動的にクラスタリングされる
- **目的**: 位置情報がないエンティティが自動配置されることを検証
- **検証内容**:
  - クラスタリング関数が呼び出される
  - エンティティに自動的に位置が割り当てられる
- **前提条件**: レイアウトデータにpositionが含まれない

##### テスト: 既存のpositionがある場合はクラスタリングされない
- **目的**: 既存の位置情報が保持されることを検証
- **検証内容**:
  - 既存の位置情報が変更されない
  - クラスタリング処理がスキップされる
- **前提条件**: レイアウトデータにpositionが含まれる

##### テスト: リバースエンジニアリング時に既存のpositionがクリアされてクラスタリングが強制される
- **目的**: リバースエンジニアリング時に位置情報がリセットされることを検証
- **検証内容**:
  - 既存の位置情報がクリアされる
  - 新しくクラスタリングが実行される
- **前提条件**: リバースエンジニアリング操作が実行される

#### 2.5 レイヤー管理

##### テスト: レイヤーの初期状態が正しく設定される
- **目的**: レイヤー管理機能の初期状態が正しく設定されることを検証
- **検証内容**:
  - layers配列が初期化される
  - デフォルトレイヤーが作成される
- **前提条件**: アプリケーションが初期化される

##### テスト: レイヤー順序変更イベントが状態を更新する
- **目的**: レイヤーの順序変更が状態に反映されることを検証
- **検証内容**:
  - layer-order-changeイベントが処理される
  - レイヤーのzIndex値が更新される
- **前提条件**: レイヤー順序変更イベントが発生する

##### テスト: レイヤー順序変更時にDOM操作が行われる
- **目的**: レイヤー順序変更がDOMに反映されることを検証
- **検証内容**:
  - DOM要素のzIndex属性が更新される
  - 正しい順序でレンダリングされる
- **前提条件**: レイヤー順序が変更される

##### テスト: レイヤー順序変更が永続化される
- **目的**: レイヤー順序の変更が保存されることを検証
- **検証内容**:
  - '/api/save-layout' への保存リクエストが発行される
  - レイヤー情報が含まれる
- **前提条件**: レイヤー順序が変更される

##### テスト: レイヤーの表示/非表示切り替えが機能する
- **目的**: レイヤーの表示状態が切り替えられることを検証
- **検証内容**:
  - レイヤーのvisibleプロパティが更新される
  - DOM要素の表示状態が変更される
- **前提条件**: レイヤー表示切り替えイベントが発生する

### 3. ユーザーインタラクション

#### 3.1 エンティティ選択

##### テスト: エンティティクリックでテーブル詳細が表示される
- **目的**: エンティティクリック時にサイドバーに詳細が表示されることを検証
- **検証内容**:
  - サイドバーのdata-visible属性が 'true' に設定される
  - current-tableにテーブル名が設定される
  - カラム情報が表示される
- **前提条件**: エンティティがクリックされる

#### 3.2 エンティティ移動

##### テスト: エンティティをドラッグできる
- **目的**: エンティティのドラッグ開始が正しく処理されることを検証
- **検証内容**:
  - ドラッグ状態が開始される
  - transform属性が更新される
- **前提条件**: マウスダウンイベントが発生する

##### テスト: エンティティドラッグでレイアウトが更新される
- **目的**: ドラッグ終了時にレイアウトが保存されることを検証
- **検証内容**:
  - 新しい位置がstate.erData.layoutに反映される
  - '/api/save-layout' への保存リクエストが発行される
- **前提条件**: ドラッグ操作が完了する

#### 3.3 注釈追加

##### テスト: 矩形注釈を追加できる
- **目的**: 矩形注釈の追加機能が正しく動作することを検証
- **検証内容**:
  - rect要素が作成される
  - 適切な属性（位置、サイズ、色）が設定される
- **前提条件**: add-rect-annotationイベントが発生する

##### テスト: テキスト注釈を追加できる
- **目的**: テキスト注釈の追加機能が正しく動作することを検証
- **検証内容**:
  - promptダイアログが表示される
  - text要素が作成される
  - 入力されたテキストが表示される
- **前提条件**: add-text-annotationイベントが発生する

##### テスト: テキスト注釈追加をキャンセルできる
- **目的**: テキスト注釈のキャンセル処理が正しく動作することを検証
- **検証内容**:
  - promptがキャンセルされた場合、注釈が追加されない
  - エラーが発生しない
- **前提条件**: promptでキャンセルが選択される

### 4. データ管理

#### 4.1 データ取得

##### テスト: エンティティクリックでテーブルDDLが取得される
- **目的**: DDL取得機能が正しく動作することを検証
- **検証内容**:
  - '/api/table-ddl?table=xxx' へのGETリクエストが発行される
  - DDL情報が取得される
- **前提条件**: DDL取得イベントが発生する

#### 4.2 データ永続化

##### テスト: レイアウト保存が正常に動作する
- **目的**: レイアウト情報の保存機能が正しく動作することを検証
- **検証内容**:
  - '/api/save-layout' へのPOSTリクエストが発行される
  - レイアウトデータがリクエストボディに含まれる
  - 成功レスポンスが返される
- **前提条件**: レイアウト保存イベントが発生する

##### テスト: リバースエンジニアリングが正常に動作する
- **目的**: データベースからER図を生成する機能が正しく動作することを検証
- **検証内容**:
  - '/api/reverse-engineer' へのPOSTリクエストが発行される
  - 新しいERデータが取得される
  - キャンバスが再描画される
- **前提条件**: リバースエンジニアリングボタンがクリックされる

### 5. UIコンポーネント

#### 5.1 ヘルプパネル

##### テスト: ヘルプパネルの初期化時にStorageから折りたたみ状態を読み込む
- **目的**: ヘルプパネルの状態が永続化されることを検証
- **検証内容**:
  - storage.getItem('help-collapsed')が呼び出される
  - 保存された状態が復元される
- **前提条件**: アプリケーションが初期化される

##### テスト: ヘルプパネルを展開時にStorageに状態が保存される
- **目的**: ヘルプパネル展開時の状態保存を検証
- **検証内容**:
  - storage.setItem('help-collapsed', 'false')が呼び出される
  - ヘルプパネルのaria-expanded属性が 'true' に設定される
- **前提条件**: ヘルプパネルが展開される

##### テスト: ヘルプパネルを折りたたみ時にStorageに状態が保存される
- **目的**: ヘルプパネル折りたたみ時の状態保存を検証
- **検証内容**:
  - storage.setItem('help-collapsed', 'true')が呼び出される
  - ヘルプパネルのaria-expanded属性が 'false' に設定される
- **前提条件**: ヘルプパネルが折りたたまれる

#### 5.2 サイドバー

##### テスト: サイドバーの開閉が正常に動作する
- **目的**: サイドバーの表示/非表示切り替えが正しく動作することを検証
- **検証内容**:
  - sidebarのdata-visible属性が切り替わる
  - addClassとremoveClassが適切に呼び出される
- **前提条件**: サイドバー切り替えイベントが発生する

#### 5.3 オーバーレイ

##### テスト: コンテキストメニューが表示される
- **目的**: 右クリックでコンテキストメニューが表示されることを検証
- **検証内容**:
  - contextmenu要素が作成される
  - 適切な位置に表示される
  - メニュー項目が含まれる
- **前提条件**: 右クリックイベントが発生する

##### テスト: ローディング表示が正常に動作する
- **目的**: 非同期処理中のローディング表示が正しく動作することを検証
- **検証内容**:
  - loading-overlay要素が作成される
  - 処理完了後に削除される
- **前提条件**: 非同期処理が実行される

### 6. 状態管理

#### 6.1 状態の変更通知

##### テスト: 状態の変更が正しく通知される
- **目的**: 状態変更時にリスナーへの通知が正しく行われることを検証
- **検証内容**:
  - 状態変更リスナーが呼び出される
  - 変更内容が正しく通知される
- **前提条件**: 状態が変更される

#### 6.2 プロパティ監視

##### テスト: プロパティ変更の監視が正常に動作する
- **目的**: 特定プロパティの変更監視が正しく動作することを検証
- **検証内容**:
  - プロパティ変更時にコールバックが呼び出される
  - 新旧の値が正しく渡される
- **前提条件**: 監視対象プロパティが変更される

#### 6.3 ヒストリー管理

##### テスト: ヒストリー機能が正常に動作する
- **目的**: 操作履歴の管理機能が正しく動作することを検証
- **検証内容**:
  - 操作履歴が記録される
  - undo/redo機能が動作する
- **前提条件**: 状態変更操作が実行される

### 7. エラーハンドリング

##### テスト: ネットワークエラーが適切に処理される
- **目的**: ネットワークエラー時の処理が正しく行われることを検証
- **検証内容**:
  - エラーメッセージがログに記録される
  - アプリケーションがクラッシュしない
- **前提条件**: ネットワークエラーが発生する

##### テスト: 無効なテーブル名でのDDL取得エラーが処理される
- **目的**: 不正なテーブル名でのDDL取得時のエラー処理を検証
- **検証内容**:
  - 400エラーが適切に処理される
  - エラーメッセージが表示される
- **前提条件**: 無効なテーブル名でDDL取得が試みられる

##### テスト: JSONパースエラーが適切に処理される
- **目的**: 不正なJSONレスポンス時の処理を検証
- **検証内容**:
  - パースエラーがキャッチされる
  - エラーログが記録される
- **前提条件**: 不正なJSONが返される

##### テスト: 権限エラー（403 Forbidden）が適切に処理される
- **目的**: 権限不足エラーの処理を検証
- **検証内容**:
  - 403エラーが適切に処理される
  - ユーザーに適切なメッセージが表示される
- **前提条件**: 403エラーが発生する

##### テスト: レート制限エラー（429 Too Many Requests）が適切に処理される
- **目的**: レート制限エラーの処理を検証
- **検証内容**:
  - 429エラーが適切に処理される
  - リトライロジックが動作する
- **前提条件**: 429エラーが発生する

##### テスト: レイアウト保存時のサーバーエラーが適切に処理される
- **目的**: レイアウト保存時のエラー処理を検証
- **検証内容**:
  - 500エラーが適切に処理される
  - データの整合性が保たれる
- **前提条件**: レイアウト保存時に500エラーが発生する

##### テスト: DDL取得時のサーバーエラーが適切に処理される
- **目的**: DDL取得時のエラー処理を検証
- **検証内容**:
  - サーバーエラーが適切に処理される
  - DDL表示部分が適切に更新される
- **前提条件**: DDL取得時にエラーが発生する

##### テスト: 無効なエンティティデータのエラーが適切に処理される
- **目的**: 不正なエンティティデータの処理を検証
- **検証内容**:
  - 不正なデータがスキップされる
  - 正常なデータのみが処理される
- **前提条件**: 不正なエンティティデータが含まれる

##### テスト: リバースエンジニアリング時のエラーが適切に処理される
- **目的**: リバースエンジニアリング失敗時の処理を検証
- **検証内容**:
  - エラーメッセージが表示される
  - 既存のデータが保持される
- **前提条件**: リバースエンジニアリング時にエラーが発生する

### 8. 増分リバースエンジニアリング

以下のテストは増分リバースエンジニアリング機能を検証します：

##### テスト: 増分リバースエンジニアリング - 既存レイアウトを保持しながら新しいエンティティを追加
- **目的**: 既存レイアウトを保持したまま新規エンティティを追加する機能の検証
- **検証内容**:
  - 既存エンティティのレイアウトが保持される
  - 新規エンティティがクラスタリングされて追加される
  - レイアウト保存リクエストが発行される

##### テスト: 増分リバースエンジニアリング - 削除されたエンティティのレイアウトを削除
- **目的**: データベースから削除されたエンティティのレイアウト情報削除の検証
- **検証内容**:
  - 削除されたエンティティのレイアウトデータが自動的に削除される
  - DOM要素からも削除される
  - レイアウト保存時に削除されたエンティティが含まれない

##### テスト: 増分リバースエンジニアリング - 既存エンティティの位置とサイズを保持
- **目的**: 既存エンティティの位置情報保持の検証
- **検証内容**:
  - 既存エンティティの位置（x, y）とサイズ（width, height）が変更されない
  - DOM要素のtransform属性が保持される

##### テスト: 増分リバースエンジニアリング - 複数の新規エンティティが適切にクラスタリングされる
- **目的**: 新規エンティティの自動配置機能の検証
- **検証内容**:
  - 複数の新規エンティティが重ならないように配置される
  - 適切な間隔で自動配置される
  - クラスタリング後にレイアウトが保存される

## 📊 テストカバレッジ目標

- **ステートメントカバレッジ**: 85%以上
- **ブランチカバレッジ**: 80%以上
- **関数カバレッジ**: 90%以上
- **行カバレッジ**: 85%以上

## 🔧 テスト実行方法

```bash
# 全テスト実行
npm test

# 特定のテストのみ実行
npm test -- --testNamePattern="エンティティ"

# カバレッジレポート生成
npm test -- --coverage

# ウォッチモードで実行
npm test -- --watch
```

## 📝 注意事項

1. **Mock検証の重要性**: stateの直接検証ではなく、Infrastructure Mockの呼び出し履歴を検証することで、実装の詳細に依存しないテストを実現
2. **非同期処理の扱い**: `await new Promise((resolve) => setTimeout(resolve, 0))` を使用して、非同期処理の完了を待つ
3. **テストの独立性**: 各テストケースは他のテストに依存せず、独立して実行可能
4. **可読性の維持**: DRY原則よりも可読性を優先し、リテラル値を直接使用

## 🚀 今後の改善点

1. **パフォーマンステスト**: 大量のエンティティ処理時のパフォーマンステストの追加
2. **アクセシビリティテスト**: キーボード操作やスクリーンリーダー対応のテスト
3. **ブラウザ互換性テスト**: 異なるブラウザでの動作確認テスト
4. **統合テスト**: 実際のバックエンドとの統合テストの追加

---

最終更新: 2025-01-06